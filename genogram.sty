%============================================================%
%      Copyright (C) 2019 by Alessandro Sciarra
%
% This file may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either
% version 1.3 of this license or (at your option) any later
% version. The latest version of this license is in:
%
%       http://www.latex-project.org/lppl.txt
%
% and version 1.3 or later is part of all distributions of
% LaTeX version 2005/12/01 or later.
%============================================================%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{genogram}[2019/03/22 v1.0b Package to simply draw simple genograms]

\RequirePackage{tikz}

\usetikzlibrary{%
    shapes.geometric,     %for square
    positioning,          %for 'right = xxx of'
    calc,                 %for coordinate calculations
    backgrounds,          %for framed tikzpictures
    decorations.markings  %for separated and divorced styles
}

%============================================================%
% The idea is to create commands to gather from the user
% all the needed information for the final \drawGenogram
% command, where then the tikz pikture is drawn. The key
% tree is structured in a way such that the top level
% refers to the couple and sub-levels refer to the
% correspondent relatives.
%
% The prefix gen@ is used to emulate a "genogram" namespace.
%
% Some more keys are needed for some fine-tuning or at least
% to store defaults of drawn elements in the genogram.
%============================================================%

%============================================================%
\newlength{\twoDigitsNumberWidth}
\settowidth{\twoDigitsNumberWidth}{00}
\tikzset{%
    Square/.style={%
        inner sep=\pgfkeysvalueof{/genogram/space around age},
        regular polygon, regular polygon sides=4,
        node contents={\makebox[\twoDigitsNumberWidth]{#1}}
    },
    Circle/.style={%
        circle,
        inner sep=\pgfkeysvalueof{/genogram/space around age},
        /utils/exec={%
            \pgfmathsetmacro\polygonIncircleDiameter{
                sqrt(2)*max(\twoDigitsNumberWidth+2*\pgfshapeinnerxsep, height("#1") + depth("#1") + 2 * \pgfshapeinnerysep)
            }
        },
        minimum size=\polygonIncircleDiameter,
        node contents={\makebox[\twoDigitsNumberWidth]{#1}}
    },
    add coordinates above and below/.style={
        append after command={%
            \pgfextra{%
                \coordinate (\tikzlastnode @above) at ($(\tikzlastnode.center)+(0,\pgfkeysvalueof{/genogram/generation distance}/2)$);
                \coordinate (\tikzlastnode @below) at ($(\tikzlastnode.center)-(0,\pgfkeysvalueof{/genogram/generation distance}/2)$);
            }
        }
    },
    male/.style={draw, Square=#1, add coordinates above and below},
    female/.style={draw, Circle=#1, add coordinates above and below},
    shorter/.style={shorten >= #1, shorten <= #1},
    alive/.style={}, %nothing to change
    dead/.style={opacity=0.5,
        append after command={%
            \pgfextra{%
                \draw[thin, shorter=0.3pt] (\tikzlastnode.south west) -- (\tikzlastnode.north east);
                \draw[thin, shorter=0.3pt] (\tikzlastnode.south east) -- (\tikzlastnode.north west);
            }
        }
    },
    married style/.style={}, %nothing to change, simple line
    not married style/.style={dashed},
    separated style/.style={
        postaction={
            decorate,decoration={
                markings,
                mark=at position .5 with {
                    \node[inner xsep=\pgfkeysvalueof{/genogram/broken couple symbol width},
                          inner ysep=\pgfkeysvalueof{/genogram/broken couple symbol height}, append after command={
                        \pgfextra{%
                            \draw[thick] (\tikzlastnode.south west) -- (\tikzlastnode.north east);
                        }
                    }]{};
                }
            }
        }
    },
    divorced style/.style={
        postaction={
            decorate,decoration={
                markings,
                mark=at position .5 with {
                    \node[inner xsep=\pgfkeysvalueof{/genogram/broken couple symbol width},
                          inner ysep=\pgfkeysvalueof{/genogram/broken couple symbol height}, append after command={
                        \pgfextra{%
                            \draw[thick] (\tikzlastnode.south west) -- (\tikzlastnode.north east)
                                         (\tikzlastnode.south east) -- (\tikzlastnode.north west);
                        }
                    }]{};
                }
            }
        }
    }
}

\pgfkeysdef{/handlers/.value}{%
    \pgfkeysvalueof{\pgfkeyscurrentpath}%
}

%============================================================%
%Counters for genogram people
\newcounter{NumberOfChildren}
\newcounter{NumberOfHusbandSiblings}
\newcounter{NumberOfWifeSiblings}
%Counters for drawing
\newcounter{NumberOfHusbandPeopleToDraw}
\setcounter{NumberOfHusbandPeopleToDraw}{1}%
\newcounter{NumberOfWifePeopleToDraw}
\setcounter{NumberOfWifePeopleToDraw}{1}%
%If-clauses for some logic
\newif\if@husband@father@set
\newif\if@husband@mother@set
\newif\if@wife@father@set
\newif\if@wife@mother@set
\newif\if@genogram@default@were@set
\@genogram@default@were@setfalse
%============================================================%

%============================================================%
\pgfkeys{%
    /couple/.is family, /couple,
    %---------------------------------------------------------------------------------
    husband/default/.style={%
        /couple/husband/.cd,
        sex/.initial=male,
        life status/.initial=alive,
        age/.initial={},
        age/.value required,
        name/.initial={},
        name/.value required,
        after sibling/.initial/.expanded={\theNumberOfHusbandSiblings},
        extra node/.style={},
        extra label/.style={},
        %Here remain in /couple/husband as needed by \husband command
    },
    husband/status/.style={/couple/status=#1},
    husband/male/.style={/couple/husband/sex=male},      % for completeness
    husband/male/.value forbidden,
    husband/female/.style={/couple/husband/sex=female},  % for completeness
    husband/female/.value forbidden,
    husband/dead/.style={/couple/husband/life status=dead},
    husband/dead/.value forbidden,
    husband/extra node feature/.style={/couple/husband/extra node/.style={#1}},
    husband/extra label feature/.style={/couple/husband/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    wife/default/.style={%
        /couple/wife/.cd,
        sex/.initial=female,
        life status/.initial=alive,
        age/.initial={},
        age/.value required,
        name/.initial={},
        name/.value required,
        after sibling/.initial/.expanded={\theNumberOfWifeSiblings},
        extra node/.style={},
        extra label/.style={},
        %Here remain in /couple/husband as needed by \husband command
    },
    wife/status/.style={/couple/status=#1},
    wife/male/.style={/couple/wife/sex=male},      % for completeness
    wife/male/.value forbidden,
    wife/female/.style={/couple/wife/sex=female},  % for completeness
    wife/female/.value forbidden,
    wife/dead/.style={/couple/wife/life status=dead},
    wife/dead/.value forbidden,
    wife/extra node feature/.style={/couple/wife/extra node/.style={#1}},
    wife/extra label feature/.style={/couple/wife/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    last child/default/.style={%
        /couple/child\theNumberOfChildren/.cd,
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=male,
        extra node/.style={},
        extra label/.style={},
        /couple/last child/.cd % This is called by EVERY \child and it has to change back to /couple/last child
        % NOTE: The default must be in \child and not here since the counter change at every time a default must be invoked!
    },
    last child/age/.value required,
    last child/age/.style={/couple/child\theNumberOfChildren/age=#1},
    last child/name/.value required,
    last child/name/.style={/couple/child\theNumberOfChildren/name=#1},
    last child/male/.style={/couple/child\theNumberOfChildren/sex=male},
    last child/male/.value forbidden,
    last child/female/.style={/couple/child\theNumberOfChildren/sex=female},
    last child/female/.value forbidden,
    last child/dead/.style={/couple/child\theNumberOfChildren/life status=dead},
    last child/dead/.value forbidden,
    last child/extra node feature/.style={/couple/child\theNumberOfChildren/extra node/.style={#1}},
    last child/extra label feature/.style={/couple/child\theNumberOfChildren/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    % Key of in order to understand relationships
    of/.initial=husband,
    of/.belongs to family=/couple, % In order to use \pgfqkeysfiltered
    of/.value required,
    %---------------------------------------------------------------------------------
    father/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/father=true, % connected to \if@...@father@set
        /couple/\pgfkeysvalueof{/couple/of}/father/.cd,
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=male,
        extra node/.style={},
        extra label/.style={},
        /couple/father/.cd % This is called by EVERY \father and it has to change back to /couple/father
    },
    father/status/.style={/couple/\pgfkeysvalueof{/couple/of}/parents/status=#1},
    father/age/.value required,
    father/age/.style={/couple/\pgfkeysvalueof{/couple/of}/father/age=#1},
    father/name/.value required,
    father/name/.style={/couple/\pgfkeysvalueof{/couple/of}/father/name=#1},
    father/male/.style={/couple/\pgfkeysvalueof{/couple/of}/father/sex=male},      % for completeness
    father/male/.value forbidden,
    father/female/.style={/couple/\pgfkeysvalueof{/couple/of}/father/sex=female},  % for completeness
    father/female/.value forbidden,
    father/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/father/life status=dead},
    father/dead/.value forbidden,
    father/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/father/extra node/.style={#1}},
    father/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/father/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    mother/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/mother=true,  % connected to \if@...@mother@set
        /couple/\pgfkeysvalueof{/couple/of}/mother/.cd,
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=female,
        extra node/.style={},
        extra label/.style={},
        /couple/mother/.cd % This is called by EVERY \mother and it has to change back to /couple/mother
    },
    mother/status/.style={/couple/\pgfkeysvalueof{/couple/of}/parents/status=#1},
    mother/age/.value required,
    mother/age/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/age=#1},
    mother/name/.value required,
    mother/name/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/name=#1},
    mother/male/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/sex=male},      % for completeness
    mother/male/.value forbidden,
    mother/female/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/sex=female},  % for completeness
    mother/female/.value forbidden,
    mother/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/life status=dead},
    mother/dead/.value forbidden,
    mother/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/extra node/.style={#1}},
    mother/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/mother/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    brother/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/.cd,
        has partner/.initial=0, %this means false, better than .is if -> to be used in \ifnum
        number of children/.initial=0,
        status drawing style/.initial=married style,
        status/.is choice,
        status/married/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=married style},
        status/not married/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=not married style},
        status/separated/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=separated style},
        status/divorced/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=divorced style},
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=male,
        extra node/.style={},
        extra label/.style={},
        /couple/brother/.cd % This is called by EVERY \brother and it has to change back to /couple/brother
    },
    brother/status/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status=#1},
    brother/age/.value required,
    brother/age/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/age=#1},
    brother/name/.value required,
    brother/name/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/name=#1},
    brother/male/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/sex=male},      % for completeness
    brother/male/.value forbidden,
    brother/female/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/sex=female},  % for completeness
    brother/female/.value forbidden,
    brother/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/life status=dead},
    brother/dead/.value forbidden,
    brother/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/extra node/.style={#1}},
    brother/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    sister/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/.cd,
        has partner/.initial=0, %this means false, better than .is if -> to be used in \ifnum
        number of children/.initial=0,
        status drawing style/.initial=married style,
        status/.is choice,
        status/married/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=married style},
        status/not married/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=not married style},
        status/separated/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=separated style},
        status/divorced/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status drawing style=divorced style},
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=female,
        extra node/.style={},
        extra label/.style={},
        /couple/sister/.cd % This is called by EVERY \brother and it has to change back to /couple/brother
    },
    sister/status/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status=#1},
    sister/age/.value required,
    sister/age/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/age=#1},
    sister/name/.value required,
    sister/name/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/name=#1},
    sister/male/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/sex=male},      % for completeness
    sister/male/.value forbidden,
    sister/female/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/sex=female},  % for completeness
    sister/female/.value forbidden,
    sister/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/life status=dead},
    sister/dead/.value forbidden,
    sister/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/extra node/.style={#1}},
    sister/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    brother in law/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/has partner=1,
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/.cd,
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=male,
        extra node/.style={},
        extra label/.style={},
        /couple/brother in law/.cd % This is called by EVERY \brotherInLaw and it has to change back to /couple/brother in law
    },
    brother in law/status/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status=#1},
    brother in law/age/.value required,
    brother in law/age/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/age=#1},
    brother in law/name/.value required,
    brother in law/name/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/name=#1},
    brother in law/male/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/sex=male},      % for completeness
    brother in law/male/.value forbidden,
    brother in law/female/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/sex=female},  % for completeness
    brother in law/female/.value forbidden,
    brother in law/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/life status=dead},
    brother in law/dead/.value forbidden,
    brother in law/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/extra node/.style={#1}},
    brother in law/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    sister in law/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/has partner=1,
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/.cd,
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=female,
        extra node/.style={},
        extra label/.style={},
        /couple/sister in law/.cd % This is called by EVERY \sisterInLaw and it has to change back to /couple/sister in law
    },
    sister in law/status/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/status=#1},
    sister in law/age/.value required,
    sister in law/age/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/age=#1},
    sister in law/name/.value required,
    sister in law/name/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/name=#1},
    sister in law/male/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/sex=male},      % for completeness
    sister in law/male/.value forbidden,
    sister in law/female/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/sex=female},  % for completeness
    sister in law/female/.value forbidden,
    sister in law/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/life status=dead},
    sister in law/dead/.value forbidden,
    sister in law/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/extra node/.style={#1}},
    sister in law/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/partner/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    nibling/default/.style={%
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/.cd,
        number of children/.expanded={\the\numexpr\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}+1\relax},
        /couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/.cd,
        life status/.initial=alive,
        age/.initial={},
        name/.initial={},
        sex/.initial=male,
        extra node/.style={},
        extra label/.style={},
        /couple/nibling/.cd % This is called by EVERY \nibling and it has to change back to /couple/nibling
    },
    nibling/age/.value required,
    nibling/age/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/age=#1},
    nibling/name/.value required,
    nibling/name/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/name=#1},
    nibling/male/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/sex=male},      % for completeness
    nibling/male/.value forbidden,
    nibling/female/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/sex=female},  % for completeness
    nibling/female/.value forbidden,
    nibling/dead/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/life status=dead},
    nibling/dead/.value forbidden,
    nibling/extra node feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/extra node/.style={#1}},
    nibling/extra label feature/.style={/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/child\pgfkeysvalueof{/couple/\pgfkeysvalueof{/couple/of}/sibling\pgfkeysvalueof{/couple/sibling number to be used}/number of children}/extra label/.style={#1}},
    %---------------------------------------------------------------------------------
    %=================== INTERNAL KEYS NOT THOUGHT FOR THE USER ======================
    husband/father/.is if=@husband@father@set,
    husband/father/.initial=false,
    husband/mother/.is if=@husband@mother@set,
    husband/mother/.initial=false,
    wife/father/.is if=@wife@father@set,
    wife/father/.initial=false,
    wife/mother/.is if=@wife@mother@set,
    wife/mother/.initial=false,
    status drawing style/.initial={married style},
    status/.is choice,
    status/married/.style={/couple/status drawing style=married style},
    status/not married/.style={/couple/status drawing style=not married style},
    status/separated/.style={/couple/status drawing style=separated style},
    status/divorced/.style={/couple/status drawing style=divorced style},
    husband/parents/status drawing style/.initial={married style},
    husband/parents/status/.is choice,
    husband/parents/status/married/.style={/couple/husband/parents/status drawing style=married style},
    husband/parents/status/not married/.style={/couple/husband/parents/status drawing style=not married style},
    husband/parents/status/separated/.style={/couple/husband/parents/status drawing style=separated style},
    husband/parents/status/divorced/.style={/couple/husband/parents/status drawing style=divorced style},
    wife/parents/status drawing style/.initial={married style},
    wife/parents/status/.is choice,
    wife/parents/status/married/.style={/couple/wife/parents/status drawing style=married style},
    wife/parents/status/not married/.style={/couple/wife/parents/status drawing style=not married style},
    wife/parents/status/separated/.style={/couple/wife/parents/status drawing style=separated style},
    wife/parents/status/divorced/.style={/couple/wife/parents/status drawing style=divorced style},
    % The following key has to be set by the \brother or \sister command to the value of the
    % counter NumberOfHusbandSiblings or NumberOfWifeSiblings depending on the value of the key "of"
    sibling number to be used/.initial=0
}%

\pgfkeys{%
    /genogram/.is family, /genogram,
    set keys with logic to default/.code={%
        \ifnum\value{NumberOfChildren}=0
            \pgfmathparse{10*(1+\theNumberOfChildren)}%
        \else
            \pgfmathparse{5*(1+\theNumberOfChildren)}%
        \fi
        \pgfkeysalso{couple distance/.initial/.expanded={\pgfmathresult em}}%
        \pgfmathparse{5*(1+\theNumberOfHusbandSiblings)}%
        \pgfkeysalso{husband parents distance/.initial/.expanded={\pgfmathresult em}}%
        \pgfmathparse{5*(1+\theNumberOfWifeSiblings)}%
        \pgfkeysalso{wife parents distance/.initial/.expanded={\pgfmathresult em}}%
    },
    default/.style={%
        /genogram,
        /genogram/space around age/.initial=1pt,
        generation distance/.initial=3cm,
        children generation add distance below/.initial=0mm,
        broken couple symbol height/.initial=1ex,
        broken couple symbol width/.initial=0.5ex,
        siblings generation add distance above/.initial=-3mm,
        siblings generation add distance below/.initial=-3mm,
        set keys with logic to default
    }
}%

%============================================================%
%Just to consider the case the user does not use the
%\husband and/or \wife commands -> set defaults to draw them!
\pgfkeys{/couple/husband/default, /couple/wife/default}%
%============================================================%

\newcommand{\husband}[1][]{%
    \pgfqkeys{/couple/husband}{default,#1}\ignorespaces
}

\newcommand{\wife}[1][]{%
    \pgfqkeys{/couple/wife}{default,#1}\ignorespaces
}

\newcommand{\internal@child}[2][]{%
    \stepcounter{NumberOfChildren}%
    \pgfqkeys{/couple/last child}{default,#2,#1}\ignorespaces
}

\newcommand{\son}[1][]{%
    \internal@child[#1]{male}
}

\newcommand{\daughter}[1][]{%
    \internal@child[#1]{female}
}

\newcommand{\internal@checkOfValue}{%
    % See https://ctan.org/pkg/pdftex?lang=de for \pdfstrcmp
    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{husband}=0
    \else
        \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{wife}=0
        \else
            \PackageError{Genogram}{%
                Invalid value of key "of=\pgfkeysvalueof{/couple/of}"!\MessageBreak
                Specify either "husband" or "wife"%
            }{%
                Specify either "husband" or "wife"%
            }
        \fi
    \fi
}

\newcommand{\internal@parent}[2][]{%
    \pgfkeys{/pgf/key filters/and/.install key filter={/pgf/key filters/defined}{/pgf/key filters/equals=/couple/of}}%
    \pgfkeys{/pgf/key filter handlers/append filtered to/.install key filter handler=\remainingoptions}%
    \def\remainingoptions{/couple/#2/.cd,default}% Prepare key list for later in \pgfkeysalsofrom
    \pgfqkeysfiltered{/couple}{#1}%
    \internal@checkOfValue%
    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{husband}=0
        \if@husband@mother@set\else
            \pgfkeys{/couple/mother/default}%
        \fi
        \if@husband@father@set\else
            \pgfkeys{/couple/father/default}%
        \fi
    \fi
    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{wife}=0
        \if@wife@father@set\else
            \pgfkeys{/couple/father/default}%
        \fi
        \if@wife@mother@set\else
            \pgfkeys{/couple/mother/default}%
        \fi
    \fi
    % About using a macro with key list in \pgfkeys: https://tex.stackexchange.com/q/479497/128737
    \pgfkeysalsofrom{\remainingoptions}\ignorespaces
}

\newcommand{\father}[1][]{%
    \internal@parent[#1]{father}
}

\newcommand{\mother}[1][]{%
    \internal@parent[#1]{mother}
}

\newcommand{\internal@sibling}[2][]{%
    \pgfkeys{/pgf/key filters/and/.install key filter={/pgf/key filters/defined}{/pgf/key filters/equals=/couple/of}}%
    \pgfkeys{/pgf/key filter handlers/append filtered to/.install key filter handler=\remainingoptions}%
    \def\remainingoptions{/couple/#2/.cd,default}% Prepare key list for later in \pgfkeysalsofrom
    \pgfqkeysfiltered{/couple}{#1}%
    \internal@checkOfValue%
    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{husband}=0
        \stepcounter{NumberOfHusbandSiblings}%
        \stepcounter{NumberOfHusbandPeopleToDraw}%
        \pgfkeys{/couple/sibling number to be used=\theNumberOfHusbandSiblings}%
    \else
        \stepcounter{NumberOfWifeSiblings}%
        \stepcounter{NumberOfWifePeopleToDraw}%
        \pgfkeys{/couple/sibling number to be used=\theNumberOfWifeSiblings}%
    \fi
    \pgfkeysalsofrom{\remainingoptions}\ignorespaces
}

\newcommand{\brother}[1][]{%
    \internal@sibling[#1]{brother}
}

\newcommand{\sister}[1][]{%
    \internal@sibling[#1]{sister}
}

\newcommand{\internal@missingPartner}[1]{%
    \PackageError{Genogram}{%
        Wrong use of the "#1InLaw" command!\MessageBreak
        Missing command before to which it should be referred!%
    }{%
        Specify the missing command%
    }
}

\newcommand{\internal@siblinginlaw}[2][]{%
    \pgfkeys{/pgf/key filters/and/.install key filter={/pgf/key filters/defined}{/pgf/key filters/equals=/couple/of}}%
    \pgfkeys{/pgf/key filter handlers/append filtered to/.install key filter handler=\remainingoptions}%
    \def\remainingoptions{/couple/#2 in law/.cd,default}% Prepare key list for later in \pgfkeysalsofrom
    \pgfqkeysfiltered{/couple}{#1}%
    \internal@checkOfValue%
    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{husband}=0
        \ifnum\value{NumberOfHusbandSiblings}=0
            \internal@missingPartner{#2}
        \fi
        \stepcounter{NumberOfHusbandPeopleToDraw}%
        \pgfkeys{/couple/sibling number to be used=\theNumberOfHusbandSiblings}%
    \else
        \ifnum\value{NumberOfWifeSiblings}=0
            \internal@missingPartner{#2}
        \fi
        \stepcounter{NumberOfWifePeopleToDraw}%
        \pgfkeys{/couple/sibling number to be used=\theNumberOfWifeSiblings}%
    \fi
    \pgfkeysalsofrom{\remainingoptions}\ignorespaces
}

\newcommand{\brotherInLaw}[1][]{%
    \internal@siblinginlaw[#1]{brother}
}

\newcommand{\sisterInLaw}[1][]{%
    \internal@siblinginlaw[#1]{sister}
}

\newcommand{\internal@nibling}[2][]{%
    \pgfkeys{/pgf/key filters/and/.install key filter={/pgf/key filters/defined}{/pgf/key filters/equals=/couple/of}}%
    \pgfkeys{/pgf/key filter handlers/append filtered to/.install key filter handler=\remainingoptions}%
    \def\remainingoptions{/couple/nibling/.cd,default,#2}% Prepare key list for later in \pgfkeysalsofrom
    \pgfqkeysfiltered{/couple}{#1}%
    \internal@checkOfValue%
    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/of}}{husband}=0
        \pgfkeys{/couple/sibling number to be used=\theNumberOfHusbandSiblings}%
    \else
        \pgfkeys{/couple/sibling number to be used=\theNumberOfWifeSiblings}%
    \fi
    \pgfkeysalsofrom{\remainingoptions}\ignorespaces
}

\newcommand{\nephew}[1][]{%
    \internal@nibling[#1]{male}
}

\newcommand{\niece}[1][]{%
    \internal@nibling[#1]{female}
}

\newcommand{\setBeforeDrawing}[1][]{%
    \@genogram@default@were@settrue%
    \pgfqkeys{/genogram}{default,#1}\ignorespaces
}

\newcommand{\drawElement}[3][]{% #1=extra node options #2=key name, #3=prefix for node and additional coordinates
    \filename@parse{#2}
    \node[\pgfkeysvalueof{#2/sex}=\pgfkeysvalueof{#2/age}, name=#3\filename@base, \pgfkeysvalueof{#2/life status}, #2/extra node, #1];
    \node[anchor=south west, inner sep=0, inner ysep=1pt, font=\scriptsize,
          at={(#3\filename@base.north -| {$(#3\filename@base.center)!0.5!(#3\filename@base.east)$})}, #2/extra label] {\strut\pgfkeysvalueof{#2/name}};
    % The complicated "at" above is to keep the same position of label no matter if the shape is square or circle (north, center and east anchors
    % are the same and here we use the y coordinate of north and the x coortinate of the midpoint between center and east).
    %
    % Update lastCoordinate to last drawn element
    \coordinate (lastCoordinate) at (#3\filename@base.center);
}

\long\def\ifNodeDefined#1#2{% https://tex.stackexchange.com/a/85531/128737
    \@ifundefined{pgf@sh@ns@#1}{%
        \PackageError{Genogram}{%
            Logical error in drawing.\MessageBreak
            Node #1 needed but not found.\MessageBreak
            Please, check the order of your commands%
        }{%
            Check the order of your commands!
        }}{#2}%
}

\long\def\internal@extraTikzCode{}
\newcommand{\addToTikzpicture}[1]{%
    \long\def\internal@extraTikzCode{#1}\ignorespaces
}

\newcommand{\drawGenogram}[1][]{%
    \if@genogram@default@were@set\else\pgfkeys{/genogram/default}\fi%
    %Since we want to draw elements left to right in the genogram respecting the order in which they have been specified
    %(age is usually decreasing left to right), then we draw first the couple generation, treating parent/wife and siblings
    %together. Actually if siblings have partners they are also drawn here.
    \begin{tikzpicture}[framed]
        %Draw husband with his siblings plus in case brother/sister in law
        \pgfmathsetlengthmacro{\husbandPeopleDistance}{\pgfkeysvalueof{/genogram/husband parents distance}/(\theNumberOfHusbandSiblings+1)}
        \path coordinate (firstHusbandPerson) at (0,0)
              coordinate (lastCoordinate) at (firstHusbandPerson);
        \ifnum\value{NumberOfHusbandSiblings}>0%
            \ifnum\pgfkeysvalueof{/couple/husband/after sibling}=0
                \drawElement[at=(lastCoordinate)]{/couple/husband}{gen@}
            \else
                %Correct last coordinate by the increment by \wifePeopleDistance in order to have
                %the correct distance between the husband and wife people
                \coordinate (lastCoordinate) at ($(lastCoordinate)-(\husbandPeopleDistance,0)$);
            \fi
            \foreach \n in {1,...,\theNumberOfHusbandSiblings}{
                %Draw sibling with partner if any respecting male-left-to-female notation
                \drawElement[at={($(lastCoordinate)+(\husbandPeopleDistance,0)$)}]{/couple/husband/sibling\n}{gen@husband@}
                \ifnum\pgfkeysvalueof{/couple/husband/sibling\n/has partner}=1
                    \coordinate (tmp) at (lastCoordinate);
                    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/husband/sibling\n/sex}}{male}=0
                        \drawElement[at={($(lastCoordinate)+(0.5*\husbandPeopleDistance,0)$)}]{/couple/husband/sibling\n/partner}{gen@husband@sibling\n @}
                    \else
                        \drawElement[at={($(lastCoordinate)-(0.5*\husbandPeopleDistance,0)$)}]{/couple/husband/sibling\n/partner}{gen@husband@sibling\n @}
                    \fi
                    %Draw niblings if any!
                    \pgfmathsetmacro{\theNumberOfNiblings}{\pgfkeysvalueof{/couple/husband/sibling\n/number of children}}
                    \ifnum\theNumberOfNiblings>0
                        \foreach \c in {1,...,\theNumberOfNiblings}{
                            \pgfmathsetmacro{\dyNibling}{\pgfkeysvalueof{/genogram/generation distance}/2+\pgfkeysvalueof{/genogram/siblings generation add distance above}+\pgfkeysvalueof{/genogram/siblings generation add distance below}}
                            \coordinate (childPos) at ($(gen@husband@sibling\n @below)!{(-0.5+\c)/\theNumberOfNiblings}!(gen@husband@sibling\n @partner@below)-(0,\dyNibling pt)$);
                            \drawElement[at={(childPos)}]{/couple/husband/sibling\n/child\c}{gen@husband@sibling\n @}
                            \draw (gen@husband@sibling\n @child\c.north) --
                                  (gen@husband@sibling\n @child\c.north |- {$(gen@husband@sibling\n @below)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$});
                                  %($(gen@husband@sibling\n @child\c @above)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance below})-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$);
                        }
                    \fi
                    %Restore last sibling coordinate to continue drawing correctly
                    \coordinate (lastCoordinate) at (tmp);
                \fi
                \ifnum\pgfkeysvalueof{/couple/husband/after sibling}=\n
                    \drawElement[at={($(lastCoordinate)+(\husbandPeopleDistance,0)$)}]{/couple/husband}{gen@}
                \fi
                %Draw connections
                \draw (gen@husband@sibling\n.north) -- (gen@husband@sibling\n @above);
                \ifnum\pgfkeysvalueof{/couple/husband/sibling\n/has partner}=1
                    \draw[\pgfkeysvalueof{/couple/husband/sibling\n/status drawing style}]
                        (gen@husband@sibling\n @partner.south) --
                        ($(gen@husband@sibling\n @partner@below)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$) --
                        ($(gen@husband@sibling\n @below)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$) --
                        (gen@husband@sibling\n.south);
                \fi
            }
        \else
            \drawElement[at=(lastCoordinate)]{/couple/husband}{gen@}
        \fi
        \coordinate (lastHusbandPerson) at (lastCoordinate);
        %Draw wife with her siblings plus in case brother/sister in law
        \pgfmathsetlengthmacro{\wifePeopleDistance}{\pgfkeysvalueof{/genogram/wife parents distance}/(\theNumberOfWifeSiblings+1)}
        % Here we jump from the last husband person to the first wife person (partner excluded), but we want to respect the
        % couple distance. Then, we want to calculate this jump distance accordingly.
        \pgfmathparse{%
            \pgfkeysvalueof{/genogram/couple distance}
            -(\theNumberOfHusbandSiblings - \pgfkeysvalueof{/couple/husband/after sibling})*\husbandPeopleDistance
            -\pgfkeysvalueof{/couple/wife/after sibling}*\husbandPeopleDistance
        }
        \path coordinate (lastCoordinate) at ($(lastCoordinate)+(\pgfmathresult pt,0)$)
              coordinate (firstWifePerson) at (lastCoordinate);
        \ifnum\value{NumberOfWifeSiblings}>0%
            \ifnum\pgfkeysvalueof{/couple/wife/after sibling}=0
                \drawElement[at=(lastCoordinate)]{/couple/wife}{gen@}
            \else
                %Correct last coordinate by the increment by \wifePeopleDistance in order to have
                %the correct distance between the husband and wife people
                \coordinate (lastCoordinate) at ($(lastCoordinate)-(\wifePeopleDistance,0)$);
            \fi
            \foreach \n in {1,...,\theNumberOfWifeSiblings}{
                %Draw sibling with partner if any respecting male-left-to-female notation
                \drawElement[at={($(lastCoordinate)+(\wifePeopleDistance,0)$)}]{/couple/wife/sibling\n}{gen@wife@}
                \ifnum\pgfkeysvalueof{/couple/wife/sibling\n/has partner}=1
                    \coordinate (tmp) at (lastCoordinate);
                    \ifnum\pdfstrcmp{\pgfkeysvalueof{/couple/wife/sibling\n/sex}}{male}=0
                        \drawElement[at={($(lastCoordinate)+(0.5*\wifePeopleDistance,0)$)}]{/couple/wife/sibling\n/partner}{gen@wife@sibling\n @}
                    \else
                        \drawElement[at={($(lastCoordinate)-(0.5*\wifePeopleDistance,0)$)}]{/couple/wife/sibling\n/partner}{gen@wife@sibling\n @}
                    \fi
                    %Draw niblings if any!
                    \pgfmathsetmacro{\theNumberOfNiblings}{\pgfkeysvalueof{/couple/wife/sibling\n/number of children}}
                    \ifnum\theNumberOfNiblings>0
                        \foreach \c in {1,...,\theNumberOfNiblings}{
                            \pgfmathsetmacro{\dyNibling}{\pgfkeysvalueof{/genogram/generation distance}/2+\pgfkeysvalueof{/genogram/siblings generation add distance above}+\pgfkeysvalueof{/genogram/siblings generation add distance below}}
                            \coordinate (childPos) at ($(gen@wife@sibling\n @below)!{(-0.5+\c)/\theNumberOfNiblings}!(gen@wife@sibling\n @partner@below)-(0,\dyNibling pt)$);
                            \drawElement[at={(childPos)}]{/couple/wife/sibling\n/child\c}{gen@wife@sibling\n @}
                            \draw (gen@wife@sibling\n @child\c.north) --
                                  ($(gen@wife@sibling\n @child\c @above)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance below})-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$);
                        }
                    \fi
                    %Restore last sibling coordinate to continue drawing correctly
                    \coordinate (lastCoordinate) at (tmp);
                \fi
                \ifnum\pgfkeysvalueof{/couple/wife/after sibling}=\n
                    \drawElement[at={($(lastCoordinate)+(\wifePeopleDistance,0)$)}]{/couple/wife}{gen@}
                \fi
                %Draw connections
                \draw (gen@wife@sibling\n.north) -- (gen@wife@sibling\n @above);
                \ifnum\pgfkeysvalueof{/couple/wife/sibling\n/has partner}=1
                    \draw[\pgfkeysvalueof{/couple/wife/sibling\n/status drawing style}]
                        (gen@wife@sibling\n @partner.south) --
                        ($(gen@wife@sibling\n @partner@below)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$) --
                        ($(gen@wife@sibling\n @below)-(0,\pgfkeysvalueof{/genogram/siblings generation add distance above})$) --
                        (gen@wife@sibling\n.south);
                \fi
            }
        \else
            \drawElement[at=(lastCoordinate)]{/couple/wife}{gen@}
        \fi
        \coordinate (lastWifePerson) at (lastCoordinate);
        %Now that the couple has been drawn, connect it
        \draw[\pgfkeysvalueof{/couple/status drawing style}] (gen@husband.south) -- (gen@husband@below) -- (gen@wife@below) -- (gen@wife.south);
        %Draw children if some (husband and wife nodes always exist because of default values!)
        \ifnum\value{NumberOfChildren}>0%
            \foreach \n in {1,...,\theNumberOfChildren}{
                \pgfmathsetmacro{\dyChildren}{\pgfkeysvalueof{/genogram/generation distance}/2+\pgfkeysvalueof{/genogram/children generation add distance below}}
                \coordinate (childPos) at ($(gen@husband@below)!{(-0.5+\n)/\theNumberOfChildren}!(gen@wife@below)-(0,\dyChildren pt)$);
                \drawElement[at=(childPos)]{/couple/child\n}{gen@}
                \draw (gen@child\n.north) -- ($(gen@child\n @above)+(0,\pgfkeysvalueof{/genogram/children generation add distance below})$);
            }
        \fi
        %Draw parents of husband assuming as it should be that if one is defined, both are (see \internal@parent command)
        \if@husband@mother@set
            \drawElement[at={($(gen@husband@above -| firstHusbandPerson)+(-\husbandPeopleDistance/2,\pgfkeysvalueof{/genogram/generation distance}/2)$)}]{/couple/husband/father}{gen@husband@}
            \drawElement[at={($(gen@husband@father)+(\pgfkeysvalueof{/genogram/husband parents distance},0)$)}]{/couple/husband/mother}{gen@husband@}
            \draw[\pgfkeysvalueof{/couple/husband/parents/status drawing style}] (gen@husband@father.south) -- (gen@husband@father@below) -- (gen@husband@mother@below) -- (gen@husband@mother.south);
            \draw (gen@husband) -- (gen@husband@above);
        \fi
        %Draw parents of wife assuming as it should be that if one is defined, both are (see \internal@parent command)
        \if@wife@mother@set
            \drawElement[at={($(gen@wife@above -| firstWifePerson)+(-\wifePeopleDistance/2,\pgfkeysvalueof{/genogram/generation distance}/2)$)}]{/couple/wife/father}{gen@wife@}
            \drawElement[at={($(gen@wife@father)+(\pgfkeysvalueof{/genogram/wife parents distance},0)$)}]{/couple/wife/mother}{gen@wife@}
            \draw[\pgfkeysvalueof{/couple/wife/parents/status drawing style}] (gen@wife@father.south) -- (gen@wife@father@below) -- (gen@wife@mother@below) -- (gen@wife@mother.south);
            \draw (gen@wife) -- (gen@wife@above);
        \fi
        %Connect husband and/or wife to siblings in case no parents have been specified and there are siblings
        \ifnum\value{NumberOfHusbandSiblings}=0\else
            \if@husband@mother@set\else %parents go together so just one if is OK
                \draw (gen@husband) -- (gen@husband@above);
                \draw ($(firstHusbandPerson)+(0,\pgfkeysvalueof{/genogram/generation distance}/2)$) -- ($(lastHusbandPerson)+(0,\pgfkeysvalueof{/genogram/generation distance}/2)$);
            \fi
        \fi
        \ifnum\value{NumberOfWifeSiblings}=0\else
            \if@wife@mother@set\else %parents go together so just one if is OK
                \draw (gen@wife) -- (gen@wife@above);
                \draw ($(firstWifePerson)+(0,\pgfkeysvalueof{/genogram/generation distance}/2)$) -- ($(lastWifePerson)+(0,\pgfkeysvalueof{/genogram/generation distance}/2)$);
            \fi
        \fi
        %Finish with whatever the user wishes
        \internal@extraTikzCode
    \end{tikzpicture}\ignorespaces
}
